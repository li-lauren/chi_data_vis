<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://d3js.org/d3.v5.js"></script>
    <link rel="stylesheet" href="/static/css/styles.css">
</head>
<body>
    <!-- Slider -->
    <h3>Chicago Public Urination Tickets</h3>
    <div>
        <input id="slide" type="range" min="1" max="7" value="0" step="1">
        <br>
        <span id="time-label">January</span>
    </div>

    <!-- Maps -->
    <div id="map-2019"></div>
    <div id="map-2020"></div>

    <script>
        // Define variables for time slider
        let timeOpts = ["January","February","March","April","May","June", "July"];
        let timeValMonth = null;
        
        // Wrote drawMap as a reusable function to avoid repeating code for 
        // the two graphs
        function drawMap(dom, jsonPath) {
            // Append SVG
            let width = 600;
            let height = 600;

            let svg = d3.select(dom)
                .append("svg")
                .attr("width", width)
                .attr("height", height);

            // Add DIV for tooltip
            let tooltip = d3.select("body")
                .append("div")
                .style("opacity", 0)
                .attr("class", "tooltip")
            
            
            // Load Map and Public Urination JSON (2019)
            Promise.all([d3.json("data/chi_comm_areas.geojson"), d3.json(jsonPath)])
            .then(function(data) {
                let map = data[0];
                let urin_recs = data[1];

                // Append Chicago Community Area Map
                let proj = d3.geoAlbers()
                    .fitSize([width, height], map)
                    
                let geoPath = d3.geoPath().projection(proj);

                let g = svg.append("g");

                g.selectAll('path')
                    .data(map.features)
                    .join('path')
                    .attr('d', geoPath)
                    .attr('fill', '#088')
                    .attr('stroke', '#000'); 

                // Load Urination Records Data
                let urin_tix = svg.append("g");

                urin_tix.selectAll("path")
                    .data(urin_recs.features)
                    .enter()
                    .append("path")
                    .attr("fill", initFill)
                    .attr("stroke","#999")
                    .attr("d", geoPath)
                    .attr("class", "ticket")
                    .on("mouseover", function(d) {
                        tooltip.transition()
                            .duration(200)
                            .style("opacity", 0.9)
                            .style("left", d3.event.pageX + "px")
                            .style("top", d3.event.pageY + 10 + "px")
                        let address = d.properties.STR_ADDRESS
                        tooltip.html(address.substring(1,address.length-1))
                    })
                    .on("mouseout", function(d) {
                        tooltip.transition()
                            .duration(500)
                            .style("opacity", 0);
                    });
            });
        }

        
        // Update ticket color in response to time slide
        d3.select("#slide").on("input", function() {
            updateFill(this.value);
        })

        function updateFill (val) {
            console.log(val)
            console.log(timeOpts[val-1])
            document.getElementById("time-label").innerHTML=timeOpts[val-1];
            
            timeValMonth = val;
            d3.selectAll(".ticket")
                .attr("fill", getColor);
        }

        // Check if ticket issue date matches slider input, if so, assign a diff color
        function getColor(data, val) {
            // get ticket issue date from JSON
            let month = data.properties.NOV_DATE.split('/')[0];
            
            if ( timeValMonth == month) {
                // helps make matches always appear in top layer
                if (this.parentElement != null) {
                    this.parentElement.appendChild(this);
                    console.log(month) 
                    return "red";
                }
            } else {
                return "#999";
            };
        }

        // Set initial ticket fill (start with Jan 2019)
        function initFill (data, i) {
            let month = data.properties.NOV_DATE[0].split('/')[0];

            // 1 -> Jan 2019
            if (month == 1) {
                console.log(month) 
                this.parentElement.appendChild(this);
                return "red";
            } else {
                return "#999";
            };
        }

        // Draw both 2019 and 2020 maps
        drawMap('#map-2019', 'data/urin_rec_2019.json');
        drawMap('#map-2020', 'data/urin_rec_2020.json');
        
    </script>
    
</body>
</html>